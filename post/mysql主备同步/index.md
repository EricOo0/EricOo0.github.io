# Mysql 主备同步


mysql搭建主备同步数据库

<!--more-->

  ## 主从同步数据库作用：

​    从数据库起备份作用；

​    主服务器挂掉的时候，从服务器可以起作用；

​    可以用来做读写分离 

  ## 分工-流程：

​    主数据服务器：主要用来从业务服务写入数据或者修改更新数据。

​    从数据服务器：主要用来读取业务所需要的数据

​    二进制日志(bin-log)：用来存储写入以及更新的数据信息的操作

​    中继日志：承接主服务器数据信息，转存在从服务器上

​    I/O线程：监听主服务器是否发生数据更改的行为，有则更新到中继日志上

​    SQL线程：将主服务器数据更改的数据从中继日志文件中读取操作并写入到从数据服务器中

![master-slave.png](/img/master-slave.png)

​	当主数据服务器master进行写入数据或者更新数据操作的时候，数据更改会记录在二进制日志（binary log file）中，主服务器master与从服务器slave进行通讯的是I/O线程，它将修改的数据**异步复制**写入到slave服务器的中继日志（relay log file）中,从服务器slave与中继日志之间通信使用SQL线程，SQL线程可以异步从中继日志中读取数据后再写入到自己的数据库中，就完成了数据的主从同步功能。

## 搭建

> 1、
>
> centos默认安装的是mariadb，是mysql的一个开源分支，使用基本一致。
>
> 先安装maridb-server：
>
> yum -y install mariadb mariadb-server
>
> 启动服务：service mariadb start
>
> 2、 
>
> mysql的配置文件位置：
>
> /etc/my.cnf
>
> 用/usr/bin/mysql -v --help 可查看默认配置从哪读
>
> 3、配置数据库
>
> 主数据库配置：如图，设置打开二进制日志功能，id为1，需要同步的数据库为master_test；
>
> ![master_sql](/img/master_sql.png)
>
> 从数据库配置:  如果需要互为主备，则配置其id为2，配置二进制日志位置
>
> ![slave_sql](/img/slave_sql.png)
>
> 4、在主数据库创建同步用户并授权
>
> grant replication slave on *.* to 'slave_test'@'ip_addr' identified by '123456';
>
> 创建用户'slave_test'@'ip_addr'并授于replication slave权限，拥有此权限可以查看从服务器，从主服务器读取二进制日志。
>
> 用show master status 可以查看master数据库当前正在使用的二进制日志及当前执行二进制日志位置
>
> ![image-20220114204634830](/img/master_status.png)
>
> 5、在从服务器上输入命令修改主服务器设置：
>
> change master to master_host='ip_addr',master_user='slave_test',master_password='123456',master_log_file='mysql-bin-master.000001',master_log_pos=405;
>
> 6、从服务器上启动 slave服务
>
> start slave；
>
> 7、 查看slave状态
>
> show slave status\G
>
> 8、如果需要互为主备，则将上述过程反过来重复一遍
>
> 如果主数据库原本就有数据，需要先将数据dump到从数据库在启动slave

# 从数据库的复制方式

默认为异步复制：主库在执行完客户端提交的事务后会立即将结果返给给客户端，并不关心从库是否已经接收并处理，这样就会有一个问题，主如果crash掉了，此时主上已经提交的事务可能并没有传到从库上，如果此时，强行将从提升为主，可能导致新主上的数据不完整。

全同步复制：当主库执行完一个事务，所有的从库都执行了该事务才返回给客户端。因为需要等待所有从库执行完该事务才能返回，所以全同步复制的性能必然会收到严重的影响。

半同步复制：介于全同步复制与全异步复制之间的一种，主库只需要等待至少一个从库节点收到并且 Flush Binlog 到 Relay Log 文件即可，主库不需要等待所有从库给主库反馈。同时，这里只是一个收到的反馈，而不是已经完全完成并且提交的反馈，如此，节省了很多时间。

4、主从同步在物理上必然有延迟的现象，在业务追求较高一致性时 

​	1：如果追求数据一致性，可以使用全同步复制或半同步复制；

​	2:利用数据库中间件，所有的读写都走数据库中间件，通常情况下，写请求路由到主库，读请求路由到从库。当有写操作发生时的一个时间窗口内，把读操作请求到主库，后面在放到从库。

​	3:利用缓存，读操作时看看缓存是否命中，命中就去主库读，否则从库读，缓存有超时时间，和同步到从库时间接近，数据在缓冲中则证明可能还没有写入从库。
